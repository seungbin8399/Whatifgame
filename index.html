<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìƒê°ì˜ ë°”ë‹¤ â€“ ì§ˆë¬¸ ê²Œì„</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --brand:#22d3ee; --brand2:#60a5fa; --accent:#a78bfa; --ok:#34d399; --warn:#fbbf24;
      --shadow:0 10px 30px rgba(0,0,0,.45); --radius:18px
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Helvetica,Arial; background:radial-gradient(1200px 700px at 10% 0%, #0b1229, #0a1022 55%, #0a0f1f 70%, #070b17 100%); color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:20px 16px 40px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0 16px}
    .title{font-size:clamp(22px,4vw,34px);font-weight:800}
    .subtitle{color:var(--muted);font-size:13px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    button{appearance:none;border:none;color:var(--text);background:rgba(255,255,255,.06);padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow);transition:transform .06s ease, background .2s ease}
    button:hover{transform:translateY(-1px)}
    button:active{transform:translateY(0)}
    .primary{background:linear-gradient(135deg, rgba(34,211,238,.18), rgba(96,165,250,.18))}
    .ghost{background:rgba(255,255,255,.06)}
    .danger{background:linear-gradient(135deg, rgba(244,114,182,.2), rgba(167,139,250,.18))}

    .panel{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}

    .grid{display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    /* Question card */
    .q{display:flex;flex-direction:column;gap:14px}
    .q-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .badge{font-size:12px;color:#0b1224;background:linear-gradient(135deg, #22d3ee, #60a5fa);padding:6px 10px;border-radius:999px;font-weight:800}
    .q-text{font-size:clamp(20px,3.8vw,32px);font-weight:800;line-height:1.25}
    .q-sub{color:var(--muted);font-size:13px}

    .controls{display:flex;flex-wrap:wrap;gap:8px}
    .timer{display:flex;align-items:center;gap:8px;color:var(--muted)}
    .progress{height:8px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--brand2));transition:width .2s ease}

    /* side */
    .side{display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    select,input[type="search"],input[type="number"]{background:#0b1020;color:var(--text);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px}
    label{font-size:13px;color:var(--muted)}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.07);font-size:12px;cursor:pointer}
    .chip.on{background:linear-gradient(135deg, rgba(34,211,238,.22), rgba(96,165,250,.22))}

    .list{max-height:280px;overflow:auto;border:1px dashed rgba(255,255,255,.12);border-radius:12px;padding:10px}
    .mini{font-size:12px;color:var(--muted)}

    dialog{border:none;border-radius:16px;padding:0;background:#0b1224;color:var(--text);max-width:820px;width:min(92vw,820px);box-shadow:var(--shadow)}
    .dlg-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.07)}
    .dlg-body{padding:16px}
    .dlg-foot{padding:12px 16px;display:flex;justify-content:flex-end;gap:8px;border-top:1px solid rgba(255,255,255,.07)}
    textarea{width:100%;min-height:320px;background:#0b1020;color:var(--text);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">ìƒê°ì˜ ë°”ë‹¤ â€“ ì§ˆë¬¸ ê²Œì„</div>
        <div class="subtitle">í‚¤ë³´ë“œ: Space=ë‹¤ìŒ, â†/â†’=ì¹´í…Œê³ ë¦¬ ì´ë™, F=ì¦ê²¨ì°¾ê¸°, T=íƒ€ì´ë¨¸, E=í¸ì§‘, L=ì‚¬ìš©ë¬¸í•­ë³´ê¸°</div>
      </div>
      <div class="toolbar">
        <button id="btnPrev" class="ghost" title="ì´ì „ ì§ˆë¬¸">â—€ ì´ì „</button>
        <button id="btnNext" class="primary" title="ë‹¤ìŒ ì§ˆë¬¸ (Space)">ë‹¤ìŒ â–¶</button>
        <button id="btnFav" class="ghost" title="ì¦ê²¨ì°¾ê¸°/í•´ì œ (F)">â˜… ì¦ê²¨ì°¾ê¸°</button>
        <button id="btnTimer" class="ghost" title="íƒ€ì´ë¨¸ í† ê¸€ (T)">â± íƒ€ì´ë¨¸: ë”</button>
        <label class="ghost" style="padding:8px 10px;display:flex;align-items:center;gap:6px">â²
          <input id="seconds" type="number" min="10" max="300" value="60" style="width:70px;background:transparent;border:none;color:var(--text);font-weight:800"> s
        </label>
        <button id="btnExport" class="ghost" title="ì¦ê²¨ì°¾ê¸°/ì‚¬ìš©ë¬¸í•­ ë‚´ë³´ë‚´ê¸°">â¬‡ï¸ ê²°ê³¼</button>
        <button id="btnEdit" class="ghost" title="ì§ˆë¬¸ í¸ì§‘ (E)">âœï¸ í¸ì§‘</button>
      </div>
    </header>

    <div class="grid">
      <section class="panel q" aria-live="polite">
        <div class="q-head">
          <span class="badge" id="badge">ì¹´í…Œê³ ë¦¬</span>
          <span id="meta" class="mini">0 / 0</span>
        </div>
        <div id="qText" class="q-text">ë¬¸í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
        <div class="q-sub" id="qSub">ê¹Šì´ ì§ˆë¬¸: <span id="deep">(ë‹¤ìŒ ì§ˆë¬¸ë§ˆë‹¤ ë‹¬ë¼ì ¸ìš”)</span></div>
        <div class="progress"><div id="bar" class="bar"></div></div>
        <div class="controls">
          <button id="btnDeep" class="ghost" title="ìƒˆë¡œìš´ ê¹Šì´ ì§ˆë¬¸ ì œì•ˆ">ğŸ” ê¹Šì´ ì§ˆë¬¸ ì œì•ˆ</button>
          <button id="btnPass" class="ghost" title="ì´ë²ˆ ì§ˆë¬¸ íŒ¨ìŠ¤ (1íšŒ ê¶Œì¥)">â­ íŒ¨ìŠ¤</button>
          <button id="btnFull" class="ghost" title="ì „ì²´í™”ë©´">â›¶ ì „ì²´í™”ë©´</button>
        </div>
        <div class="timer" id="timerRow" hidden>
          ë‚¨ì€ ì‹œê°„: <strong id="remain">01:00</strong>
          <span class="mini">(ëë‚˜ë©´ ìë™ìœ¼ë¡œ ë‹¤ìŒ ì§ˆë¬¸)</span>
        </div>
      </section>

      <aside class="side">
        <section class="panel">
          <div class="row" style="justify-content:space-between">
            <label>ì¹´í…Œê³ ë¦¬</label>
            <div class="chips" id="catChips"></div>
          </div>
          <div class="row">
            <label>ë‚œì´ë„</label>
            <div class="chips" id="lvChips"></div>
          </div>
          <div class="row">
            <label>ê²€ìƒ‰</label>
            <input type="search" id="search" placeholder="í‚¤ì›Œë“œë¡œ ì§ˆë¬¸ ì°¾ê¸°" />
          </div>
          <div class="row">
            <label>ì •ë ¬</label>
            <select id="sort">
              <option value="default">ê¸°ë³¸</option>
              <option value="fav">ì¦ê²¨ì°¾ê¸° ìš°ì„ </option>
              <option value="used">ì‚¬ìš© ì•ˆ í•œ ì§ˆë¬¸ ìš°ì„ </option>
            </select>
          </div>
        </section>
        <section class="panel">
          <div class="row" style="justify-content:space-between;align-items:center">
            <strong>ì§ˆë¬¸ ëª©ë¡</strong>
            <span class="mini" id="countInfo"></span>
          </div>
          <div class="list" id="list"></div>
        </section>
        <section class="panel">
          <div class="row" style="justify-content:space-between;align-items:center">
            <strong>ì‚¬ìš©í•œ ì§ˆë¬¸</strong>
            <button id="btnLog" class="ghost">ë³´ê¸°/ìˆ¨ê¸°ê¸° (L)</button>
          </div>
          <div class="list" id="log" hidden></div>
        </section>
      </aside>
    </div>
  </div>

  <!-- í¸ì§‘ ëª¨ë‹¬ -->
  <dialog id="editDlg">
    <div class="dlg-head">
      <strong>ì§ˆë¬¸ í¸ì§‘</strong>
      <button id="closeEdit" class="ghost">ë‹«ê¸° âœ•</button>
    </div>
    <div class="dlg-body">
      <p class="mini">ì•„ë˜ JSON ë°°ì—´ì„ ìˆ˜ì •í•˜ì„¸ìš”. ê° í•­ëª©ì€ <code>{ q, cat, level }</code> í˜•ì‹ì…ë‹ˆë‹¤. <code>cat</code>ì€ ì¹´í…Œê³ ë¦¬(ì˜ˆ: "ì² í•™"), <code>level</code>ì€ 1~3.</p>
      <textarea id="editor"></textarea>
    </div>
    <div class="dlg-foot">
      <button id="saveEdit" class="primary">ì €ì¥</button>
    </div>
  </dialog>

  <script>
    // ===== ê¸°ë³¸ ë°ì´í„° =====
    const DEFAULT = [
      { q: 'ë‚´ ì¸ìƒì— 24ì‹œê°„ë§Œ ë‚¨ì•˜ë‹¤ë©´ ë¬´ì—‡ì„ í• ê¹Œ?', cat:'ì² í•™', level:2 },
      { q: 'ë§Œì•½ ì¢€ë¹„ ì‚¬íƒœê°€ ì˜¨ë‹¤ë©´, ëˆ„êµ¬ì™€ ì–´ë””ë¡œ ì‚´ì•„ë‚¨ì„ê¹Œ?', cat:'ìƒìƒ', level:1 },
      { q: 'ì‚¬ë‘ì€ ê°ì •ì¼ê¹Œ, ì„ íƒì¼ê¹Œ?', cat:'ê´€ê³„', level:2 },
      { q: 'ìµœê·¼ ë‚˜ë¥¼ ìš¸ë¦° í•œ ë¬¸ì¥(ì‹œ/ì±…/ëŒ€ì‚¬)ì€?', cat:'ë¬¸í•™', level:1 },
      { q: 'ìš©ê¸°ì™€ ë¬´ëª¨í•¨ì˜ ê²½ê³„ëŠ” ì–´ë””ì¼ê¹Œ?', cat:'ì² í•™', level:3 },
      { q: 'ì¢‹ì€ ìš°ì •ì´ë€ ë¬´ì—‡ì¼ê¹Œ? ì‚¬ë¡€ë¥¼ ë“¤ì–´ ì´ì•¼ê¸°í•´ë³´ì.', cat:'ê´€ê³„', level:1 },
      { q: 'ëˆì´ ììœ ë¥¼ ì¤„ê¹Œ, êµ¬ì†ì„ ì¤„ê¹Œ?', cat:'í˜„ì‹¤', level:2 },
      { q: 'í˜¼ì ìˆëŠ” ì‹œê°„: ì™¸ë¡œì›€ì¸ê°€, ììœ ì¸ê°€?', cat:'ìê¸°', level:1 },
      { q: 'ìµœê·¼ì˜ í›„íšŒ í•œ ê°€ì§€ì™€, ê·¸ë¡œë¶€í„° ë°°ìš´ ì ì€?', cat:'ìê¸°', level:2 },
      { q: 'ê¸°ì–µì„ ì§€ìš¸ ìˆ˜ ìˆë‹¤ë©´ ì§€ìš°ê³  ì‹¶ì€ ê¸°ì–µì´ ìˆë‚˜?', cat:'ì² í•™', level:3 },
      { q: 'ë‚˜ì—ê²Œ â€œì„±ì¥â€ì´ë€ ì–´ë–¤ ì¥ë©´ìœ¼ë¡œ ê¸°ì–µë ê¹Œ?', cat:'ìê¸°', level:2 },
      { q: 'ì™„ë²½í•œ í•˜ë£¨ë¥¼ ì„¤ê³„í•œë‹¤ë©´ ë¬´ì—‡ìœ¼ë¡œ ì±„ìš¸ê¹Œ?', cat:'ìƒìƒ', level:1 },
      { q: 'ì‚¬ê³¼ì™€ ìš©ì„œ ì¤‘ ë” ì–´ë ¤ìš´ ê²ƒì€ ë¬´ì—‡ì¼ê¹Œ? ì´ìœ ëŠ”?', cat:'ê´€ê³„', level:2 },
      { q: 'ì¸ê³µì§€ëŠ¥ì´ ë‚´ ì¼ì„ ëŒ€ì²´í•œë‹¤ë©´, ë‚˜ëŠ” ë¬´ì—‡ì„ í•˜ê³  ìˆì„ê¹Œ?', cat:'ì‹œì‚¬', level:2 },
      { q: 'ì£½ìŒì´ ìš°ë¦¬ ì‚¶ì— ì£¼ëŠ” íš¨ìš©ì€ ë¬´ì—‡ì¼ê¹Œ?', cat:'ì² í•™', level:3 }
    ];

    const DEEP_SUGGEST = [
      'ê·¸ë ‡ê²Œ ëŠë‚€ ê²°ì •ì ì¸ ìˆœê°„ì€ ì–¸ì œì˜€ì–´?',
      'ê·¸ ìƒê°ì´ ìƒê¸´ ë°°ê²½ì—ëŠ” ë¬´ì—‡ì´ ìˆì—ˆì„ê¹Œ?',
      'ì‹œê°„ì´ ì§€ë‚˜ë©´ ì´ ë‹µì€ ë°”ë€”ê¹Œ?',
      'ë¹„ìŠ·í•œ ìƒí™©ì—ì„œì˜ ë„ˆ ê²½í—˜ í•˜ë‚˜ë§Œ ë” ë“¤ë ¤ì¤˜.',
      'ë§Œì•½ ê°€ê¹Œìš´ ì¹œêµ¬ì—ê²Œ ì¡°ì–¸í•œë‹¤ë©´ ë­ë¼ê³  í• ê¹Œ?',
      'ë°˜ëŒ€ ì…ì¥ì—ì„œ ë³´ë©´ ì–´ë–»ê²Œ ë“¤ë¦´ê¹Œ?'
    ];

    // ===== ìƒíƒœ =====
    let state = {
      items: [],
      idx: 0,
      used: [], // index list
      fav: {},  // index:true
      cat: 'ì „ì²´',
      lv: 'ì „ì²´',
      query: '',
      sort: 'default',
      timerOn: false,
      seconds: 60,
      ticking: null
    };

    // ===== ìš”ì†Œ =====
    const qText = document.getElementById('qText');
    const qSub = document.getElementById('qSub');
    const deepSpan = document.getElementById('deep');
    const bar = document.getElementById('bar');
    const badge = document.getElementById('badge');
    const meta = document.getElementById('meta');

    const catChips = document.getElementById('catChips');
    const lvChips = document.getElementById('lvChips');
    const list = document.getElementById('list');
    const log = document.getElementById('log');

    const search = document.getElementById('search');
    const sortSel = document.getElementById('sort');

    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const btnFav = document.getElementById('btnFav');
    const btnTimer = document.getElementById('btnTimer');
    const secondsInput = document.getElementById('seconds');
    const btnExport = document.getElementById('btnExport');
    const btnEdit = document.getElementById('btnEdit');
    const btnDeep = document.getElementById('btnDeep');
    const btnPass = document.getElementById('btnPass');
    const btnFull = document.getElementById('btnFull');
    const btnLog = document.getElementById('btnLog');

    const timerRow = document.getElementById('timerRow');
    const remain = document.getElementById('remain');

    // í¸ì§‘ ëª¨ë‹¬
    const editDlg = document.getElementById('editDlg');
    const editor = document.getElementById('editor');
    const closeEdit = document.getElementById('closeEdit');
    const saveEdit = document.getElementById('saveEdit');

    // ===== ìœ í‹¸ =====
    const pad = (n)=> String(n).padStart(2,'0');
    const fmt = (s)=>{const m=Math.floor(s/60), ss=s%60; return `${pad(m)}:${pad(ss)}`}
    const uniq = (arr)=> [...new Set(arr)];

    function load(){
      try{
        const saved = JSON.parse(localStorage.getItem('sb_question_state')||'{}');
        state = Object.assign(state, saved);
        if(!Array.isArray(state.items) || state.items.length===0) state.items = DEFAULT;
      }catch(e){ state.items = DEFAULT; }
      if(typeof state.seconds !== 'number') state.seconds = 60;
      secondsInput.value = state.seconds;
    }
    function save(){
      localStorage.setItem('sb_question_state', JSON.stringify({
        items: state.items, idx: state.idx, used: state.used, fav: state.fav,
        cat: state.cat, lv: state.lv, query: state.query, sort: state.sort,
        timerOn: state.timerOn, seconds: state.seconds
      }));
    }

    function cats(){ return ['ì „ì²´', ...uniq(state.items.map(i=>i.cat))]; }
    function levels(){ return ['ì „ì²´', '1', '2', '3']; }

    function filtered(){
      let arr = state.items.map((it, i)=> ({...it, i, used: state.used.includes(i), fav: !!state.fav[i]}));
      if(state.cat!=='ì „ì²´') arr = arr.filter(x=>x.cat===state.cat);
      if(state.lv!=='ì „ì²´') arr = arr.filter(x=> String(x.level)===String(state.lv));
      if(state.query) arr = arr.filter(x=> x.q.toLowerCase().includes(state.query.toLowerCase()));
      if(state.sort==='fav') arr.sort((a,b)=> (b.fav - a.fav) || (a.used - b.used));
      else if(state.sort==='used') arr.sort((a,b)=> (a.used - b.used));
      return arr;
    }

    function setIdxByVisibleList(offset=0){
      const arr = filtered();
      if(arr.length===0){
        qText.textContent='ì¡°ê±´ì— ë§ëŠ” ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ ì¡°ì •í•´ë³´ì„¸ìš”.'; qSub.textContent=''; deepSpan.textContent='â€”'; badge.textContent='â€”'; meta.textContent='0 / 0'; bar.style.width='0%'; return;
      }
      let pos = arr.findIndex(x=> x.i===state.idx);
      if(pos===-1) pos = 0;
      pos = Math.max(0, Math.min(arr.length-1, pos+offset));
      show(arr[pos].i, arr, pos);
    }

    function show(i, arr=null, pos=null){
      state.idx = i;
      const it = state.items[i];
      const listArr = arr || filtered();
      const indexInList = (pos!=null? pos : listArr.findIndex(x=>x.i===i));

      qText.textContent = it.q;
      badge.textContent = `${it.cat} Â· Lv${it.level}`;
      deepSpan.textContent = DEEP_SUGGEST[Math.floor(Math.random()*DEEP_SUGGEST.length)];
      meta.textContent = `${indexInList+1} / ${listArr.length}`;
      bar.style.width = `${(indexInList)/(Math.max(1,listArr.length-1))*100}%`;

      renderList();
      save();
    }

    function markUsed(i){ if(!state.used.includes(i)){ state.used.push(i); save(); renderLog(); } }
    function toggleFav(i){ state.fav[i] = !state.fav[i]; save(); renderList(); }

    function renderFilters(){
      catChips.innerHTML = cats().map(c=>`<span class="chip ${state.cat===c?'on':''}" data-cat="${c}">${c}</span>`).join('');
      lvChips.innerHTML = levels().map(l=>`<span class="chip ${String(state.lv)===String(l)?'on':''}" data-lv="${l}">${l==='ì „ì²´'?'ì „ì²´':('Lv'+l)}</span>`).join('');
    }

    function renderList(){
      const arr = filtered();
      countInfo.textContent = `${arr.length}ê°œ`;
      list.innerHTML = arr.map(x=>`
        <div class="row" style="justify-content:space-between;align-items:center;margin:6px 0;padding:8px;border-radius:10px;background:rgba(255,255,255,.04)">
          <div class="mini" style="color:${x.used?'#93c5fd':'#a7f3d0'}">${x.used?'ì‚¬ìš©ë¨':'ìƒˆ ì§ˆë¬¸'}</div>
          <button data-i="${x.i}" class="ghost" style="flex:1;text-align:left;margin:0 8px">${x.q}</button>
          <button data-fav="${x.i}" class="ghost" title="ì¦ê²¨ì°¾ê¸°">${x.fav?'â˜…':'â˜†'}</button>
        </div>
      `).join('');
    }

    function renderLog(){
      log.innerHTML = state.used.map((i, n)=>{
        const it = state.items[i];
        return `<div class="mini">${n+1}. [${it.cat}/Lv${it.level}] ${it.q}</div>`;
      }).join('');
    }

    function startTimer(){ stopTimer(); state.timerOn=true; timerRow.hidden=false; let s=state.seconds; remain.textContent=fmt(s); state.ticking=setInterval(()=>{ s--; if(s<0){ stopTimer(); next(); return;} remain.textContent=fmt(s); },1000); btnTimer.textContent='â± íƒ€ì´ë¨¸: ì¼¬'; save(); }
    function stopTimer(){ if(state.ticking){clearInterval(state.ticking); state.ticking=null;} timerRow.hidden=true; state.timerOn=false; btnTimer.textContent='â± íƒ€ì´ë¨¸: ë”'; save(); }
    function restartTimerIfOn(){ if(state.timerOn) startTimer(); }

    function next(){ markUsed(state.idx); setIdxByVisibleList(+1); restartTimerIfOn(); }
    function prev(){ setIdxByVisibleList(-1); restartTimerIfOn(); }

    function exportData(){
      const favItems = Object.entries(state.fav).filter(([k,v])=>v).map(([k])=> state.items[Number(k)].q);
      const usedItems = state.used.map(i=> state.items[i].q);
      const obj = { fav: favItems, used: usedItems };
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='question_game_export.json'; a.click();
      URL.revokeObjectURL(url);
    }

    function openEditor(){ editor.value = JSON.stringify(state.items, null, 2); editDlg.showModal(); }
    function saveEditor(){
      try{
        const arr = JSON.parse(editor.value);
        if(!Array.isArray(arr)) throw new Error('ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.');
        if(!arr.every(x=> x && typeof x.q==='string' && typeof x.cat==='string' && (x.level>=1 && x.level<=3))) throw new Error('ê° í•­ëª©ì€ { q, cat, level(1~3) } í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        state.items = arr; state.idx = 0; state.used = []; save(); renderFilters(); setIdxByVisibleList(0); editDlg.close();
      }catch(e){ alert('ì €ì¥ ì‹¤íŒ¨: '+e.message); }
    }

    // ===== ì´ë²¤íŠ¸ =====
    document.getElementById('countInfo');
    const countInfo = document.getElementById('countInfo');

    catChips.addEventListener('click', (e)=>{ const c = e.target.dataset.cat; if(!c) return; state.cat=c; save(); renderFilters(); setIdxByVisibleList(0); });
    lvChips.addEventListener('click', (e)=>{ const v = e.target.dataset.lv; if(!v) return; state.lv=v; save(); renderFilters(); setIdxByVisibleList(0); });

    list.addEventListener('click', (e)=>{
      const i = e.target.getAttribute('data-i');
      const f = e.target.getAttribute('data-fav');
      if(i!=null){ show(Number(i)); }
      if(f!=null){ toggleFav(Number(f)); }
    });

    search.addEventListener('input', ()=>{ state.query = search.value.trim(); save(); setIdxByVisibleList(0); });
    sortSel.addEventListener('change', ()=>{ state.sort = sortSel.value; save(); setIdxByVisibleList(0); });

    btnNext.addEventListener('click', next);
    btnPrev.addEventListener('click', prev);
    btnFav.addEventListener('click', ()=>{ toggleFav(state.idx); });
    btnTimer.addEventListener('click', ()=> state.timerOn? stopTimer(): startTimer());
    secondsInput.addEventListener('change', (e)=>{ const v=Math.max(10, Math.min(300, parseInt(e.target.value||60))); state.seconds=v; e.target.value=v; save(); restartTimerIfOn(); });
    btnExport.addEventListener('click', exportData);
    btnEdit.addEventListener('click', openEditor);
    closeEdit.addEventListener('click', ()=> editDlg.close());
    saveEdit.addEventListener('click', saveEditor);
    btnDeep.addEventListener('click', ()=>{ deepSpan.textContent = DEEP_SUGGEST[Math.floor(Math.random()*DEEP_SUGGEST.length)]; });
    btnPass.addEventListener('click', ()=> next());
    btnFull.addEventListener('click', ()=>{ document.documentElement.requestFullscreen?.(); });
    btnLog.addEventListener('click', ()=>{ log.hidden = !log.hidden; renderLog(); });

    window.addEventListener('keydown', (e)=>{
      if(editDlg.open) return; // í¸ì§‘ ì¤‘ì—” ë‹¨ì¶•í‚¤ ë¬´ì‹œ
      if(e.key===' '||e.key==='Spacebar'){ e.preventDefault(); next(); }
      else if(e.key==='ArrowLeft'){ prev(); }
      else if(e.key==='ArrowRight'){ next(); }
      else if(e.key==='f'||e.key==='F'){ toggleFav(state.idx); }
      else if(e.key==='t'||e.key==='T'){ state.timerOn? stopTimer(): startTimer(); }
      else if(e.key==='e'||e.key==='E'){ openEditor(); }
      else if(e.key==='l'||e.key==='L'){ log.hidden = !log.hidden; renderLog(); }
    });

    // ===== ì´ˆê¸°í™” =====
    load();
    renderFilters();
    setIdxByVisibleList(0);
  </script>
</body>
</html>
